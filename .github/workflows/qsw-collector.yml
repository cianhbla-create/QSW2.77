name: QSW Collector

on:
  workflow_dispatch: {}

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 720

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install boto3 requests numpy pandas reportlab

      - name: Show repo tree (debug)
        run: |
          echo "::group::Repo tree"
          ls -la
          find . -maxdepth 3 -type f | sed 's|^\./||'
          echo "::endgroup::"

      - name: Verify collector path
        run: |
          if [ ! -f "actions_runner.py" ]; then
            echo "ERROR: actions_runner.py not found at repo root"
            exit 1
          fi

      - name: Run collector
        env:
          QSW_TRIALS: "1200"
          QSW_TRIALS_MODE: "per_condition"
          QSW_PHASE_LEN: "8"
          QSW_MAX_STEPS: "30"
          QSW_CONDITIONS: "quantum,pseudo,deterministic"

          QSW_QRNG_PROVIDERS: "anu"
          QSW_PURE: "1"
          QSW_BATCH: "1024"
          QSW_LOW_WATERMARK: "512"
          QSW_MAX_RETRIES: "20"
          QSW_BACKOFF: "3.0"
          QSW_PURE_MAX_WAIT: "2000"

          QSW_RUN_NAME: "all"
        run: |
          echo "[SANITY] Launching actions_runner.pyâ€¦"
          python actions_runner.py

      - name: Upload artifacts to GitHub (always)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: collector-logs
          path: |
            QSW_runs/**/_status/**
            QSW_runs/**/results_summary.csv
            QSW_runs/**/metadata.json
            QSW_runs/**/manifest.json
            QSW_runs/**/raw/**

      - name: Upload to Cloudflare R2 (timestamp + run id)
        if: ${{ always() }}
        env:
          AWS_ACCESS_KEY_ID:      ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY:  ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET:              ${{ secrets.R2_BUCKET }}
          R2_PREFIX:              ${{ secrets.R2_PREFIX }}
          R2_ENDPOINT_URL:        ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          if [ -z "$R2_ENDPOINT_URL" ] || [ -z "$R2_BUCKET" ]; then
            echo "[WARN] R2 secrets missing; skipping R2 upload."
            exit 0
          fi
          TS=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
          DEST="${R2_PREFIX:+$R2_PREFIX/}collector-runs/${TS}-run${{ github.run_id }}/"
          echo "[INFO] Destination: s3://$R2_BUCKET/$DEST"
          if [ -d "QSW_runs" ]; then
            aws s3 cp QSW_runs "s3://$R2_BUCKET/$DEST" --recursive \
              --endpoint-url "$R2_ENDPOINT_URL"
          else
            echo "[WARN] QSW_runs directory not found; nothing to upload."
          fi
